<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO åŸºç¡€ä¿¡æ¯ -->
    <title>vLLM æ˜¾å­˜è®¡ç®—å™¨ | åœ¨çº¿GPUæ˜¾å­˜ä½¿ç”¨é‡è®¡ç®—å·¥å…·</title>
    <meta name="description"
        content="ä¸“ä¸šçš„ vLLM æ˜¾å­˜è®¡ç®—å™¨ï¼Œæ”¯æŒå¤šç§æ¨¡å‹ç²¾åº¦ã€ä¸Šä¸‹æ–‡é•¿åº¦å’Œ Tensor Parallel é…ç½®ã€‚ç²¾ç¡®è®¡ç®—å¤§è¯­è¨€æ¨¡å‹éƒ¨ç½²æ‰€éœ€çš„ GPU æ˜¾å­˜ï¼ŒåŒ…æ‹¬æƒé‡ã€KV Cache å’Œç³»ç»Ÿå¼€é”€ã€‚">
    <meta name="keywords"
        content="vLLM, æ˜¾å­˜è®¡ç®—, GPU, OOM, å¤§è¯­è¨€æ¨¡å‹, LLM, æ·±åº¦å­¦ä¹ , æœºå™¨å­¦ä¹ , æ¨ç†ä¼˜åŒ–, Tensor Parallel, KV Cache, æ¨¡å‹éƒ¨ç½², è¶…æ˜¾å­˜, æ˜¾å­˜ä¸å¤Ÿ, çˆ†æ˜¾å­˜, The model's max seq len is larger">
    <meta name="author" content="finch-xu">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://github.com/finch-xu/vllm-deploy-memory-usage">

    <!-- ä¸»é¢˜è‰² -->
    <meta name="theme-color" content="#4f46e5">

    <!-- ç»“æ„åŒ–æ•°æ® -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "vLLM æ˜¾å­˜è®¡ç®—å™¨",
        "description": "ä¸“ä¸šçš„ vLLM æ˜¾å­˜è®¡ç®—å™¨ï¼Œç²¾ç¡®è®¡ç®—å¤§è¯­è¨€æ¨¡å‹éƒ¨ç½²æ‰€éœ€çš„ GPU æ˜¾å­˜ä½¿ç”¨é‡",
        "url": "https://github.com/finch-xu/vllm-deploy-memory-usage",
        "applicationCategory": "DeveloperApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Person",
            "name": "finch-xu",
            "url": "https://github.com/finch-xu"
        },
        "keywords": "vLLM, æ˜¾å­˜è®¡ç®—, GPU, å¤§è¯­è¨€æ¨¡å‹, LLM, æ·±åº¦å­¦ä¹ ",
        "featureList": [
            "æ”¯æŒå¤šç§æ¨¡å‹ç²¾åº¦è®¡ç®—",
            "æ”¯æŒ Tensor Parallel é…ç½®",
            "ç²¾ç¡®è®¡ç®— KV Cache å ç”¨",
            "å¤šå¡éƒ¨ç½²æ˜¾å­˜é¢„ä¼°",
            "å®æ—¶æ˜¾å­˜ä½¿ç”¨é‡è®¡ç®—"
        ]
    }
    </script>
    <style>
        :root {
            --p: #4f46e5;
            --bg: #f8fafc;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            padding: 20px;
            color: #1e293b;
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            transition: 0.2s;
        }

        input[type="text"]:focus {
            border-color: var(--p);
        }

        button {
            background: var(--p);
            color: white;
            border: none;
            padding: 0 25px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            background: #4338ca;
        }

        button:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .tags {
            display: flex;
            gap: 8px;
            margin: 15px 0;
            min-height: 24px;
        }

        .tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 99px;
            font-weight: bold;
        }

        .tag.moe {
            background: #eff6ff;
            color: #1d4ed8;
        }

        .tag.mla {
            background: #f0fdf4;
            color: #15803d;
        }

        .tag.fp8 {
            background: #fffbeb;
            color: #b45309;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .box {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: 0.2s;
        }

        .box:focus-within {
            border-color: #cbd5e1;
            background: #fff;
        }

        label {
            display: block;
            font-size: 0.75rem;
            font-weight: bold;
            color: #64748b;
            margin-bottom: 5px;
        }

        select,
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            box-sizing: border-box;
            background: white;
        }

        /* å¤§å·å‚æ•°é‡è¾“å…¥æ¡† */
        .big-input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--p);
            outline: none;
            padding: 0;
        }

        /* å»æ‰æ•°å­—è¾“å…¥æ¡†çš„å°ç®­å¤´(å¯é€‰) */
        /* input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; } */

        .result {
            margin-top: 30px;
            padding: 20px;
            background: #eef2ff;
            border-radius: 12px;
            border: 1px solid #c7d2fe;
        }

        .row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .bar-con {
            height: 24px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            display: flex;
            margin: 15px 0;
        }

        .bar {
            height: 100%;
            transition: width 0.2s ease-out;
        }

        /* åŠ å¿«åŠ¨ç”»å“åº” */
        .err {
            color: #dc2626;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        /* å¤šå¡æ˜¾ç¤ºæ ·å¼ */
        .gpu-card {
            margin-top: 20px;
            padding: 20px;
            background: #eef2ff;
            border-radius: 12px;
            border: 1px solid #c7d2fe;
        }

        .gpu-card-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--p);
            margin-bottom: 15px;
        }

        #multi_gpu_result {
            margin-top: 30px;
        }
    </style>
</head>

<body>

    <div class="card">
        <h2 style="color:var(--p); margin-top:0;">vLLM æ˜¾å­˜è®¡ç®—å™¨</h2>

        <div class="input-group">
            <input type="text" id="modelId" placeholder="è¾“å…¥HFæ¨¡å‹ID" value="Qwen/Qwen3-4B-Instruct-2507" style="flex: 1;">
            <button onclick="fetchData()" id="btnFetch">æŸ¥è¯¢</button>
        </div>
        <div id="errorBox" class="err"></div>

        <div id="mainUI" style="opacity: 0.5; pointer-events: none; transition: opacity 0.3s;">
            <div class="tags" id="tagArea"></div>

            <div class="grid">
                <div class="box">
                    <label>æ€»å‚æ•°é‡ (Billion) - å¯ç¼–è¾‘</label>
                    <div style="display:flex; align-items:baseline;">
                        <input type="number" id="disp_params" class="big-input" value="0" step="0.01">
                        <span style="font-weight:bold; color:var(--p)">B</span>
                    </div>
                </div>
                <div class="box">
                    <label>æƒé‡ç²¾åº¦</label>
                    <select id="precision">
                        <!-- é€‰é¡¹å°†ä»åç«¯åŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
                <div class="box">
                    <label>Context Length</label>
                    <select id="ctx_len">
                        <!-- é€‰é¡¹å°†ä»åç«¯åŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
                <div class="box">
                    <label>Max Num Seqs (å¯åŠ¨é¢„ç•™)</label>
                    <select id="max_seqs">
                        <!-- é€‰é¡¹å°†ä»åç«¯åŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
                <div class="box">
                    <label>Running Batch (å¹¶å‘æ•°)</label>
                    <input type="number" id="bs" value="1" min="1">
                </div>
                <div class="box">
                    <label>å•å¡æ€»æ˜¾å­˜ (GB)</label>
                    <input type="number" id="total_vram" value="80" min="1">
                </div>
                <div class="box">
                    <label>Tensor Parallel (å¤šå¡éƒ¨ç½²)</label>
                    <select id="tp_size">
                        <!-- é€‰é¡¹å°†ä»åç«¯åŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
                <div class="box">
                    <label>KV Cache Dtype (--kv-cache-dtype)</label>
                    <select id="kv_cache_dtype">
                        <!-- é€‰é¡¹å°†ä»åç«¯åŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
            </div>

            <div style="margin: 25px 0;">
                <button onclick="calc()"
                    style="width: 100%; padding: 14px 30px; font-size: 1.1rem; background: var(--p); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 8px rgba(79, 70, 229, 0.3);"
                    onmouseover="this.style.background='#4338ca'; this.style.boxShadow='0 4px 12px rgba(79, 70, 229, 0.4)'"
                    onmouseout="this.style.background='var(--p)'; this.style.boxShadow='0 2px 8px rgba(79, 70, 229, 0.3)'">
                    ğŸ”„ è®¡ç®—æ˜¾å­˜
                </button>
            </div>

            <div id="result_container">
                <!-- å•å¡æ˜¾ç¤º -->
                <div class="result" id="single_gpu_result">
                    <div class="bar-con">
                        <div id="bw" class="bar" style="background:#3b82f6;width:0%"></div>
                        <div id="bo" class="bar" style="background:#ef4444;width:0%"></div>
                        <div id="bk" class="bar" style="background:#f59e0b;width:0%"></div>
                    </div>
                    <div class="row"><span>ğŸ“¦ æƒé‡</span><span id="res_w">0 GB</span></div>
                    <div class="row" style="color:#dc2626"><span>âš™ï¸ é¢„ç•™</span><span id="res_o">0 GB</span></div>
                    <div class="row" style="color:#d97706"><span>ğŸ§  KV Cache</span><span id="res_k">0 GB</span></div>
                    <div class="row" style="border-top:1px solid #ccc; padding-top:10px; font-weight:bold;">
                        <span>âš¡ æ€»å ç”¨</span>
                        <span><span id="res_t">0</span> / <span id="res_limit">0</span> GB</span>
                    </div>
                </div>

                <!-- å¤šå¡æ˜¾ç¤º -->
                <div id="multi_gpu_result" style="display:none;">
                    <div id="gpu_cards_container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let G_Spec = null;
        let G_Options = null;

        // é¡µé¢åŠ è½½æ—¶è·å–å‚æ•°é€‰é¡¹
        async function loadOptions() {
            try {
                const res = await fetch('/api/get_options');
                if (res.ok) {
                    G_Options = await res.json();
                    initializeOptions();
                }
            } catch (e) {
                console.error('Failed to load options:', e);
            }
        }

        // åˆå§‹åŒ–å‚æ•°é€‰é¡¹
        function initializeOptions() {
            if (!G_Options) return;

            // åˆå§‹åŒ–ç²¾åº¦é€‰é¡¹
            const precisionSelect = document.getElementById('precision');
            precisionSelect.innerHTML = '';
            G_Options.precision.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                precisionSelect.appendChild(option);
            });
            precisionSelect.value = G_Options.precision.default;

            // åˆå§‹åŒ–ä¸Šä¸‹æ–‡é•¿åº¦é€‰é¡¹
            const ctxSelect = document.getElementById('ctx_len');
            ctxSelect.innerHTML = '';
            G_Options.ctx_len.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                ctxSelect.appendChild(option);
            });
            ctxSelect.value = G_Options.ctx_len.default;

            // åˆå§‹åŒ– Max Num Seqs é€‰é¡¹
            const maxSeqsSelect = document.getElementById('max_seqs');
            maxSeqsSelect.innerHTML = '';
            G_Options.max_seqs.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                maxSeqsSelect.appendChild(option);
            });
            maxSeqsSelect.value = G_Options.max_seqs.default;

            // åˆå§‹åŒ– TP é€‰é¡¹
            const tpSelect = document.getElementById('tp_size');
            tpSelect.innerHTML = '';
            G_Options.tp_size.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                tpSelect.appendChild(option);
            });
            tpSelect.value = G_Options.tp_size.default;

            // åˆå§‹åŒ– KV Cache Dtype é€‰é¡¹
            const kvCacheDtypeSelect = document.getElementById('kv_cache_dtype');
            kvCacheDtypeSelect.innerHTML = '';
            G_Options.kv_cache_dtype.options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.label;
                kvCacheDtypeSelect.appendChild(option);
            });
            kvCacheDtypeSelect.value = G_Options.kv_cache_dtype.default;

            // åˆå§‹åŒ–æ•°å­—è¾“å…¥æ¡†é»˜è®¤å€¼
            document.getElementById('bs').value = G_Options.batch_size.default;
            document.getElementById('total_vram').value = G_Options.total_vram.default;
        }

        // é¡µé¢åŠ è½½æ—¶è°ƒç”¨
        window.addEventListener('DOMContentLoaded', loadOptions);

        async function fetchData() {
            const mid = document.getElementById('modelId').value.trim();
            const btn = document.getElementById('btnFetch');
            const err = document.getElementById('errorBox');

            if (!mid) return;

            btn.disabled = true;
            btn.innerText = "åŠ è½½ä¸­...";
            err.innerText = "";

            try {
                const url = `/api/model_specs?model_id=${mid}`;

                const res = await fetch(url);
                if (!res.ok) {
                    const dat = await res.json();
                    throw new Error(dat.detail || "è¯·æ±‚å¤±è´¥");
                }

                G_Spec = await res.json();
                renderUI();
            } catch (e) {
                err.innerText = "âŒ " + e.message;
            } finally {
                btn.disabled = false;
                btn.innerText = "æŸ¥è¯¢";
            }
        }

        function renderUI() {
            document.getElementById('mainUI').style.opacity = '1';
            document.getElementById('mainUI').style.pointerEvents = 'auto';

            // è°ƒè¯•ï¼šè¾“å‡ºå®Œæ•´çš„ G_Spec æ•°æ®
            console.log('=== API è¿”å›çš„å®Œæ•´æ¨¡å‹æ•°æ® ===');
            console.log(JSON.stringify(G_Spec, null, 2));
            console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');

            // å°† API è¿”å›çš„å‚æ•°é‡å¡«å…¥è¾“å…¥æ¡†
            // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„ params_bï¼Œåç«¯å·²ç»åšäº†æ­£ç¡®çš„è®¡ç®—
            let paramsB = G_Spec.params_b || 0;

            // å¦‚æœåç«¯æ²¡æœ‰è¿”å›å‚æ•°é‡ï¼ˆæå°‘è§æƒ…å†µï¼‰ï¼Œä½¿ç”¨ calc_params_b ä½œä¸ºå¤‡é€‰
            if (!paramsB && G_Spec.calc_params_b) {
                paramsB = G_Spec.calc_params_b;
                console.log('ä½¿ç”¨åç«¯è®¡ç®—çš„å‚æ•°é‡:', paramsB, 'B');
            }

            document.getElementById('disp_params').value = paramsB;

            // è‡ªåŠ¨é€‰æ‹©ç²¾åº¦ï¼ˆæ ¹æ®æ¨¡å‹çš„å®é™…å­˜å‚¨æ ¼å¼ï¼‰
            const precisionSelect = document.getElementById('precision');
            let selectedPrecision = "2";  // é»˜è®¤ BF16

            // ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„ is_fp8 æ ‡å¿—
            if (G_Spec.is_fp8) {
                selectedPrecision = "1";  // F8_E4M3
            } else {
                // å¯¹äºé FP8 æ¨¡å‹ï¼Œé»˜è®¤ä½¿ç”¨ BF16ï¼ˆHuggingFace ä¸Šå¤§å¤šæ•°æ¨¡å‹çš„æ ‡å‡†æ ¼å¼ï¼‰
                // ç”¨æˆ·å¯ä»¥æ ¹æ®å®é™…æƒ…å†µæ‰‹åŠ¨è°ƒæ•´
                selectedPrecision = "2";  // BF16
            }

            precisionSelect.value = selectedPrecision;

            // è‡ªåŠ¨é€‰æ‹©ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆæ ¹æ®æ¨¡å‹åŸç”Ÿæœ€å¤§ä¸Šä¸‹æ–‡é•¿åº¦ï¼‰
            const maxCtx = G_Spec.max_position_embeddings || 8192;  // é»˜è®¤ 8K
            const ctxOptions = [
                { value: "8192", label: "8K" },
                { value: "32768", label: "32K" },
                { value: "65536", label: "64K" },
                { value: "131072", label: "128K" },
                { value: "262144", label: "256K" }
            ];
            const ctxSelect = document.getElementById('ctx_len');

            // æ¸…ç†ä¹‹å‰å¯èƒ½æ·»åŠ çš„ç‰¹æ®Šé€‰é¡¹ï¼ˆä¿ç•™å‰5ä¸ªé¢„è®¾é€‰é¡¹ï¼‰
            while (ctxSelect.options.length > 5) {
                ctxSelect.remove(5);
            }

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ ç‰¹æ®Šé€‰é¡¹
            const isSpecialCtx = !ctxOptions.some(opt => parseInt(opt.value) === maxCtx);
            if (isSpecialCtx && maxCtx > 0) {
                // æ·»åŠ ç‰¹æ®Šä¸Šä¸‹æ–‡é•¿åº¦é€‰é¡¹
                const specialOption = document.createElement('option');
                specialOption.value = maxCtx.toString();
                specialOption.textContent = `${maxCtx.toLocaleString()} (æ¨¡å‹åŸç”Ÿ)`;
                ctxSelect.appendChild(specialOption);
            }

            // é€‰æ‹©æœ€æ¥è¿‘ä½†ä¸è¶…è¿‡æ¨¡å‹æœ€å¤§å€¼çš„é€‰é¡¹
            let selectedCtx = "8192";
            for (let i = 0; i < ctxOptions.length; i++) {
                if (parseInt(ctxOptions[i].value) <= maxCtx) {
                    selectedCtx = ctxOptions[i].value;
                } else {
                    break;
                }
            }
            // å¦‚æœæ˜¯ç‰¹æ®Šä¸Šä¸‹æ–‡é•¿åº¦ï¼Œç›´æ¥é€‰æ‹©å®ƒ
            if (isSpecialCtx) {
                selectedCtx = maxCtx.toString();
            }
            ctxSelect.value = selectedCtx;

            // Tags
            const tags = document.getElementById('tagArea');
            tags.innerHTML = '';
            if (G_Spec.is_moe) tags.innerHTML += `<span class="tag moe">MoE (${G_Spec.num_experts} Exp)</span>`;
            if (G_Spec.is_mla) tags.innerHTML += `<span class="tag mla">MLA Enabled</span>`;
            if (G_Spec.is_fp8) tags.innerHTML += `<span class="tag fp8">FP8 Config</span>`;
            if (G_Spec.is_vl) tags.innerHTML += `<span class="tag moe" style="background:#e0f2fe;color:#0284c7">VL Model</span>`;

            calc();
        }

        // æ ¸å¿ƒè®¡ç®—å‡½æ•°ï¼šè°ƒç”¨åç«¯ API è¿›è¡Œè®¡ç®—
        async function calc() {
            try {
                // 1. è¯»å– DOM å€¼
                const paramsB = parseFloat(document.getElementById('disp_params').value) || 0;
                const prec = parseFloat(document.getElementById('precision').value);
                const ctx = parseInt(document.getElementById('ctx_len').value);
                const maxSeq = parseInt(document.getElementById('max_seqs').value);
                const bs = parseInt(document.getElementById('bs').value) || 1;
                const limit = parseFloat(document.getElementById('total_vram').value) || 80;
                const tpSize = parseInt(document.getElementById('tp_size').value) || 1;
                const kvCacheDtype = parseFloat(document.getElementById('kv_cache_dtype').value) || 2;

                // 2. è·å–æ¨¡å‹å‚æ•°
                let hidden_size, layers, kv_heads, head_dim, is_mla, kv_lora_rank, qk_rope_dim;

                if (G_Spec) {
                    hidden_size = G_Spec.hidden_size || 4096;
                    layers = G_Spec.layers || 32;
                    const attn_heads = G_Spec.num_attention_heads || 32;
                    kv_heads = G_Spec.num_key_value_heads || Math.max(1, Math.floor(attn_heads / 4));
                    head_dim = G_Spec.head_dim || Math.floor(hidden_size / attn_heads);
                    is_mla = G_Spec.is_mla || false;
                    kv_lora_rank = G_Spec.kv_lora_rank || 512;
                    qk_rope_dim = G_Spec.qk_rope_dim || 64;
                } else {
                    hidden_size = 4096;
                    layers = 32;
                    kv_heads = 8;
                    head_dim = 128;
                    is_mla = false;
                    kv_lora_rank = 512;
                    qk_rope_dim = 64;
                }

                // 3. æ„å»º POST è¯·æ±‚ä½“
                const requestBody = {
                    params_b: paramsB,
                    precision: prec,
                    ctx_len: ctx,
                    max_seqs: maxSeq,
                    batch_size: bs,
                    total_vram: limit,
                    tp_size: tpSize,
                    hidden_size: hidden_size,
                    layers: layers,
                    kv_heads: kv_heads,
                    head_dim: head_dim,
                    is_mla: is_mla,
                    kv_lora_rank: kv_lora_rank,
                    qk_rope_dim: qk_rope_dim,
                    kv_cache_dtype: kvCacheDtype
                };

                // 4. è°ƒç”¨åç«¯ API (ä½¿ç”¨ POST)
                const response = await fetch('/api/calculate_memory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('API è¯·æ±‚å¤±è´¥');
                }

                const result = await response.json();

                // 5. æ ¹æ® TP å¤§å°åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼
                if (tpSize === 1) {
                    // å•å¡æ¨¡å¼
                    document.getElementById('single_gpu_result').style.display = 'block';
                    document.getElementById('multi_gpu_result').style.display = 'none';

                    // æ ¹æ®çŠ¶æ€è®¾ç½®å¡ç‰‡é¢œè‰²
                    const resultCard = document.getElementById('single_gpu_result');
                    if (result.status === 'error') {
                        resultCard.style.background = '#fee2e2';
                        resultCard.style.borderColor = '#ef4444';
                    } else if (result.status === 'warning') {
                        resultCard.style.background = '#fef3c7';
                        resultCard.style.borderColor = '#f59e0b';
                    } else {
                        resultCard.style.background = '#eef2ff';
                        resultCard.style.borderColor = '#c7d2fe';
                    }

                    // æ›´æ–°å•å¡æ˜¾ç¤º
                    document.getElementById('res_w').innerText = result.weights.total + " GB";
                    document.getElementById('res_o').innerText = result.overhead.total + " GB";
                    document.getElementById('res_k').innerText = result.kv_cache.total + " GB";
                    document.getElementById('res_t').innerText = result.total_memory.per_gpu;
                    document.getElementById('res_limit').innerText = result.total_vram;

                    // è¿›åº¦æ¡
                    let pw = (result.weights.total / result.total_vram) * 100;
                    let po = (result.overhead.total / result.total_vram) * 100;
                    let pk = (result.kv_cache.total / result.total_vram) * 100;

                    document.getElementById('bw').style.width = Math.min(pw, 100) + "%";
                    document.getElementById('bo').style.width = Math.min(po, 100) + "%";
                    document.getElementById('bk').style.width = Math.min(pk, 100) + "%";
                } else {
                    // å¤šå¡æ¨¡å¼
                    document.getElementById('single_gpu_result').style.display = 'none';
                    document.getElementById('multi_gpu_result').style.display = 'block';

                    // ç”Ÿæˆå¤šå¡æ˜¾ç¤º
                    const container = document.getElementById('gpu_cards_container');
                    container.innerHTML = '';

                    // è¿›åº¦æ¡ç™¾åˆ†æ¯”
                    let pw = (result.weights.per_gpu / result.total_vram) * 100;
                    let po = (result.overhead.per_gpu / result.total_vram) * 100;
                    let pk = (result.kv_cache.per_gpu / result.total_vram) * 100;

                    // æ ¹æ®çŠ¶æ€è®¾ç½®æ±‡æ€»å¡ç‰‡é¢œè‰²
                    let summaryBgColor, summaryBorderColor, summaryTextColor, summaryTitle;
                    if (result.status === 'error') {
                        summaryBgColor = '#fee2e2';
                        summaryBorderColor = '#ef4444';
                        summaryTextColor = '#991b1b';
                        summaryTitle = `ğŸ“Š å¤šå¡éƒ¨ç½²æ±‡æ€» (TP=${tpSize}) âš ï¸ ${result.status_text}`;
                    } else if (result.status === 'warning') {
                        summaryBgColor = '#fef3c7';
                        summaryBorderColor = '#f59e0b';
                        summaryTextColor = '#92400e';
                        summaryTitle = `ğŸ“Š å¤šå¡éƒ¨ç½²æ±‡æ€» (TP=${tpSize}) âš ï¸ ${result.status_text}`;
                    } else {
                        summaryBgColor = '#f0fdf4';
                        summaryBorderColor = '#86efac';
                        summaryTextColor = '#15803d';
                        summaryTitle = `ğŸ“Š å¤šå¡éƒ¨ç½²æ±‡æ€» (TP=${tpSize})`;
                    }

                    // æ·»åŠ æ±‡æ€»å¡ç‰‡
                    const summaryCard = document.createElement('div');
                    summaryCard.className = 'gpu-card';
                    summaryCard.style.background = summaryBgColor;
                    summaryCard.style.borderColor = summaryBorderColor;
                    summaryCard.innerHTML = `
                    <div class="gpu-card-title" style="color:${summaryTextColor};">${summaryTitle}</div>
                    <div class="row" style="font-size:1.2rem; font-weight:bold; color:${summaryTextColor};">
                        <span>ğŸ® GPU æ•°é‡</span>
                        <span>${tpSize} å¼ </span>
                    </div>
                    <div class="row" style="font-size:1.1rem;">
                        <span>ğŸ’¾ æ¯å¡æ˜¾å­˜å ç”¨</span>
                        <span>${result.total_memory.per_gpu} GB / ${result.total_vram} GB</span>
                    </div>
                    <div class="row" style="font-size:1.1rem;">
                        <span>ğŸ“¦ æ¯å¡æƒé‡</span>
                        <span>${result.weights.per_gpu} GB</span>
                    </div>
                    <div class="row" style="font-size:1.1rem;">
                        <span>âš™ï¸ æ¯å¡é¢„ç•™</span>
                        <span>${result.overhead.per_gpu} GB</span>
                    </div>
                    <div class="row" style="font-size:1.1rem;">
                        <span>ğŸ§  æ¯å¡ KV Cache</span>
                        <span>${result.kv_cache.per_gpu} GB</span>
                    </div>
                    <div class="row" style="border-top:2px solid ${summaryBorderColor}; padding-top:10px; margin-top:10px; font-size:1.2rem; font-weight:bold; color:${summaryTextColor};">
                        <span>âš¡ æ€»æ˜¾å­˜å ç”¨</span>
                        <span>${result.total_memory.total} GB</span>
                    </div>
                    <div class="row" style="font-size:0.9rem; color:#64748b; margin-top:5px;">
                        <span>ğŸ’¡ åˆ©ç”¨ç‡</span>
                        <span style="color:${summaryTextColor}; font-weight:bold;">${result.utilization}%</span>
                    </div>
                `;
                    container.appendChild(summaryCard);

                    // ç»Ÿä¸€æ˜¾ç¤ºæ–¹å¼ï¼šæ‰€æœ‰å¤šå¡é…ç½®éƒ½æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯å’Œä¸€ä¸ªç¤ºä¾‹å¡ç‰‡
                    const exampleCard = document.createElement('div');
                    exampleCard.className = 'gpu-card';

                    // æ ¹æ®çŠ¶æ€è®¾ç½®ç¤ºä¾‹å¡ç‰‡é¢œè‰²
                    if (result.status === 'error') {
                        exampleCard.style.background = '#fee2e2';
                        exampleCard.style.borderColor = '#ef4444';
                    } else if (result.status === 'warning') {
                        exampleCard.style.background = '#fef3c7';
                        exampleCard.style.borderColor = '#f59e0b';
                    }

                    exampleCard.innerHTML = `
                    <div class="gpu-card-title">ğŸ® å•å¡ç¤ºä¾‹ (æ¯å¼ å¡ç›¸åŒé…ç½®)</div>
                    <div class="bar-con">
                        <div class="bar" style="background:#3b82f6;width:${Math.min(pw, 100)}%"></div>
                        <div class="bar" style="background:#ef4444;width:${Math.min(po, 100)}%"></div>
                        <div class="bar" style="background:#f59e0b;width:${Math.min(pk, 100)}%"></div>
                    </div>
                    <div class="row"><span>ğŸ“¦ æƒé‡</span><span>${result.weights.per_gpu} GB</span></div>
                    <div class="row" style="color:#dc2626"><span>âš™ï¸ é¢„ç•™</span><span>${result.overhead.per_gpu} GB</span></div>
                    <div class="row" style="color:#d97706"><span>ğŸ§  KV Cache</span><span>${result.kv_cache.per_gpu} GB</span></div>
                    <div class="row" style="border-top:1px solid #ccc; padding-top:10px; font-weight:bold;">
                        <span>âš¡ æ€»å ç”¨</span>
                        <span>${result.total_memory.per_gpu} / ${result.total_vram} GB</span>
                    </div>
                `;
                    container.appendChild(exampleCard);
                }

                // è°ƒè¯•ä¿¡æ¯
                console.log('=== æ˜¾å­˜è®¡ç®—ç»“æœ (æ¥è‡ªåç«¯) ===');
                console.log(result);
                console.log('=== è°ƒè¯•ä¿¡æ¯ç»“æŸ ===');

            } catch (error) {
                console.error('calc() error:', error);
            }
        }
    </script>

    <footer style="text-align: center; margin-top: 30px; padding: 20px; color: #64748b;">
        <p style="margin: 0;">
            <a href="https://github.com/finch-xu/vllm-deploy-memory-usage" target="_blank" rel="noopener noreferrer"
                style="color: var(--p); text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 16 16" fill="currentColor" aria-hidden="true">
                    <path
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
                </svg>
                finch-xu/vllm-deploy-memory-usage
            </a>
        </p>
    </footer>

</body>

</html>